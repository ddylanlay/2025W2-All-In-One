import { Meteor } from "meteor/meteor";
import { Mongo } from "meteor/mongo";
import { AgentDocument } from "../../../database/user/models/role-models/AgentDocument";
import { MeteorMethodIdentifier } from "/app/shared/meteor-method-identifier";
import { AgentCollection } from "/app/server/database/user/user-collections";
import { ApiAgent } from "../../../../shared/api-models/user/api-roles/ApiAgent";
import { meteorWrappedInvalidDataError } from "/app/server/utils/error-utils";
import { InvalidDataError } from "/app/server/errors/InvalidDataError";
import { TaskDocument } from "/app/server/database/task/models/TaskDocument";
import { TaskCollection } from "/app/server/database/task/task-collections";
import { ProfileCollection } from "/app/server/database/user/user-collections";

// -- INSERT AGENT --

//Need to check this, should we be adding something for the tasks here?
const agentInsertMethod = {
  [MeteorMethodIdentifier.AGENT_INSERT]: async (
    data: Omit<AgentDocument,"_id"> // omitting both id and createdat to be generated by the db
  ): Promise<string> => {
    const newAgent: Mongo.OptionalId<AgentDocument> = {
      ...data,
      createdAt: new Date(),
    };

    return await AgentCollection.insertAsync(newAgent);
  },
};

// -- GET AGENT --
const agentGetMethod = {
  [MeteorMethodIdentifier.AGENT_GET]: async (
    userId: string
  ): Promise<ApiAgent> => {
    const agentDoc = await AgentCollection.findOneAsync({
      userAccountId: userId,
    });

    if (!agentDoc) {
      throw meteorWrappedInvalidDataError(
        new InvalidDataError(`Agent with user ID ${userId} not found.`)
      );
    }
    const agentDTO = await mapAgentDocumentToDTO(agentDoc).catch((error) => {
      throw meteorWrappedInvalidDataError(error);
    });
    return agentDTO;
  },
};

// -- GET AGENT BY ID --
const agentGetByAgentIDMethod = {
  [MeteorMethodIdentifier.AGENT_GET_BY_AGENT_ID]: async (
    agentId: string
  ): Promise<ApiAgent> => {
    const agentDoc = await AgentCollection.findOneAsync({
      _id: agentId,
    });

    if (!agentDoc) {
      throw meteorWrappedInvalidDataError(
        new InvalidDataError(`Agent with user ID ${agentId} not found.`)
      );
    }
    const agentDTO = await mapAgentDocumentToDTO(agentDoc).catch((error) => {
      throw meteorWrappedInvalidDataError(error);
    });
    return agentDTO;
  },
};

// -- UPDATE AGENT TASKS --
const agentUpdateTasksMethod = {
  [MeteorMethodIdentifier.AGENT_UPDATE_TASKS]: async (
    userId: string,
    taskId: string
  ): Promise<void> => {
    // Try resolve by userAccountId first, then fallback to agent _id
    let agentDoc = await AgentCollection.findOneAsync({ userAccountId: userId });
    if (!agentDoc) {
      agentDoc = await AgentCollection.findOneAsync({ _id: userId });
    }

    if (!agentDoc) {
      throw meteorWrappedInvalidDataError(
        new InvalidDataError(`Agent with user ID ${userId} not found.`)
      );
    }

    // Add the task ID to the agent's task_ids array if it doesn't already exist
    const currentTaskIds = agentDoc.task_ids ?? [];
    if (!currentTaskIds.includes(taskId)) {
      const updatedTaskIds = [...currentTaskIds, taskId];
      await AgentCollection.updateAsync(
        { _id: agentDoc._id },
        { $set: { task_ids: updatedTaskIds } }
      );
    }
  },
};

async function mapAgentDocumentToDTO(agent: AgentDocument): Promise<ApiAgent> {
  const taskIds = agent.task_ids ?? [];

  const taskDocuments =
    taskIds.length > 0 ? await getTaskDocumentsMatchingIds(taskIds) : [];

  return {
    agentId: agent._id!,
    userAccountId: agent.userAccountId,
    tasks: taskDocuments.map((doc) => doc._id),
    agentCode: agent.agentCode,
    createdAt: agent.createdAt,
    profileDataId: agent.profileDataId,
  };
}

async function getTaskDocumentsMatchingIds(
  ids: string[]
): Promise<TaskDocument[]> {
  return await TaskCollection.find({
    _id: { $in: ids },
  }).fetchAsync();
}

// Get profile data by agent ID (queries agent collection first, then profile collection)
const profileGetByAgentIdMethod = {
  [MeteorMethodIdentifier.PROFILE_GET_BY_AGENT_ID]: async (
    agentId: string
  ): Promise<any> => {
    // First get the agent document to extract profileDataId
    const agentDoc = await AgentCollection.findOneAsync({
      _id: agentId,
    });

    if (!agentDoc) {
      throw meteorWrappedInvalidDataError(
        new InvalidDataError(`Agent with ID ${agentId} not found.`)
      );
    }

    // Then get the profile data using the profileDataId
    const profileDoc = await ProfileCollection.findOneAsync({
      _id: agentDoc.profileDataId,
    });

    if (!profileDoc) {
      throw meteorWrappedInvalidDataError(
        new InvalidDataError(`Profile with ID ${agentDoc.profileDataId} not found.`)
      );
    }

    return profileDoc;
  },
};

Meteor.methods({
  ...agentInsertMethod,
  ...agentGetMethod,
  ...agentUpdateTasksMethod,
  ...profileGetByAgentIdMethod,
  ...agentGetByAgentIDMethod,
});
